import"dotenv/config.js";import e from"node-telegram-bot-api";import t from"mongodb";import a from"nodemailer";const o={MESSAGE:"message",CALLBACK_QUERY:"callback_query"},s={book_activity_registration:"book_activity_registration",request_legalization:"request_legalization",ask_base_information:"ask_base_information"},{MongoClient:n}=t;let r;const i=new Map,c={};let l={from:process.env.EMAIL_ADDRESS,to:process.env.EMAIL_ADDRESS,subject:"Hello from Telegram Bot",text:"Hello world?"};const _=a.createTransport({service:"gmail",auth:{user:process.env.EMAIL_ADDRESS,pass:process.env.GMAIL_PASSWORD}});function g({bot:e,chatId:t,message:a,firstName:o,reply_to_message:s}){if(function(e){const t=Date.now(),a=(c[e]||[]).filter((e=>t-e<6e4));return a.length>=10||(c[e]=[...a,t],!1)}(t))return void e.sendMessage(t,"You are sending too many requests. Please try again later.");console.log("messageIdsMap",a);let n=i.get(t)===s?.message_id;switch(!0){case/^\/start/i.test(a):!function({bot:e,chatId:t,firstName:a}){e.sendMessage(t,"ÐŸÑ€Ð¸Ð²Ñ–Ñ‚ ðŸ™‹â€â™€ï¸Ð¢ÐµÐ±Ðµ Ð²Ñ–Ñ‚Ð°Ñ” Legal Expert-Ð±Ð¾Ñ‚. \nÐ¢ÑƒÑ‚ Ñ‚Ð¸ Ð·Ð½Ð°Ð¹Ð´ÐµÑˆ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ñ‰Ð¾Ð´Ð¾ ÑŽÑ€Ð¸Ð´Ð¸Ñ‡Ð½Ð¸Ñ… Ð¿Ð¾ÑÐ»ÑƒÐ³ Ð´Ð»Ñ Ñ‚ÐµÐ±Ðµ Ñ– Ñ‚Ð²Ð¾Ð³Ð¾ Ð±Ñ–Ð·Ð½ÐµÑÑƒ\nÐžÐ±Ð¸Ñ€Ð°Ð¹ Ñ‚Ñƒ ÑŽÑ€Ð¸Ð´Ð¸Ñ‡Ð½Ñƒ Ð¿Ð¾ÑÐ»ÑƒÐ³Ñƒ, ÑÐºÐ° Ñ‚Ð¾Ð±Ñ– Ð¿Ð°ÑÑƒÑ”\n  ",{reply_markup:{inline_keyboard:[[{text:"Ð—Ð°Ð¿Ð¸ÑÐ°Ñ‚Ð¸ÑÑ Ð½Ð° ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ñ†Ñ–ÑŽ",url:process.env.CALENDLY_SCHEDULING_URL}],[{text:"Ð—Ð°Ð¿Ð¸Ñ Ð½Ð° Ñ€ÐµÑ”ÑÑ‚Ñ€Ð°Ñ†Ñ–ÑŽ Ð´Ñ–ÑÐ»ÑŒÐ½Ð¾ÑÑ‚Ñ–",callback_data:"book_activity_registration"}],[{text:"Ð›ÐµÐ³Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ",callback_data:"request_legalization"}]]}})}({bot:e,chatId:t,firstName:o});break;case n:!function(e,t){e.sendMessage(t,"Ð”ÑÐºÑƒÑ”Ð¼Ð¾ Ð¼Ð¸ Ð·Ð²'ÑÐ¶ÐµÐ¼Ð¾ÑÑ Ð· Ð²Ð°Ð¼Ð¸ Ñ‰Ð¾Ð´Ð¾ Ð²Ð°ÑˆÐ¾Ð³Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ð½Ð°Ð¹Ð±Ð»Ð¸Ð¶Ñ‡Ð¸Ð¼ Ñ‡Ð°ÑÐ¾Ð¼.")}(e,t);break;default:!function(e,t){e.sendMessage(t,"Sorry, I don't understand.")}(e,t)}}async function m(e){e.on(o.MESSAGE,(t=>{const{chat:{id:a},text:o,from:{first_name:s},reply_to_message:n}=t;try{g({bot:e,chatId:a,message:o,firstName:s,reply_to_message:n})}catch(e){console.error("Error sending message:",e)}})),e.on(o.CALLBACK_QUERY,(t=>{try{!async function(e,{data:t,message:{chat:{id:a}}}){if(t===s.book_activity_registration&&e.sendMessage(a,"Ð’Ð¸Ð±ÐµÑ€Ñ–Ñ‚ÑŒ:",{reply_markup:{one_time_keyboard:!0,inline_keyboard:[[{text:"Ð ÐµÑ”ÑÑ‚Ñ€Ð°Ñ†Ñ–Ñ Spolka z O.O.",url:process.env.GOOGLE_FORM_URL},{text:"Ð ÐµÑ”ÑÑ‚Ñ€Ð°Ñ†Ñ–Ñ JDG",url:process.env.GOOGLE__SUB_FORM_URL}]]}}),t===s.request_legalization&&e.sendMessage(a,"Ð’Ð¸Ð±ÐµÑ€Ñ–Ñ‚ÑŒ:",{reply_markup:{one_time_keyboard:!0,inline_keyboard:[[{text:"ÐšÐ°Ñ€Ñ‚Ð° Ð¿Ð¾Ð±Ð¸Ñ‚Ñƒ Ð· PESEL UKR",callback_data:s.ask_base_information},{text:"ÐšÐ°Ñ€Ñ‚Ð° Ð¿Ð¾Ð±Ð¸Ñ‚Ñƒ",callback_data:s.ask_base_information}],[{text:"ÐšÐ°Ñ€Ñ‚Ð° Ñ€ÐµÐ·Ð¸Ð´ÐµÐ½Ñ‚Ð°",callback_data:s.ask_base_information},{text:"ÐšÐ°Ñ€Ñ‚Ð° Ð¿Ð¾Ð»ÑÐºÐ°",callback_data:s.ask_base_information}]]}}),t===s.ask_base_information){const{message_id:t,...o}=await e.sendMessage(a,"ÐŸÑ–Ð´ÐºÐ°Ð¶Ñ–Ñ‚ÑŒ, Ð±ÑƒÐ´ÑŒ Ð»Ð°ÑÐºÐ°, Ð²Ð°ÑˆÐµ Ñ–Ð¼'Ñ Ñ‚Ð° ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð½Ð¸Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñƒ?",{reply_markup:{force_reply:!0}});_.sendMail(l,((t,o)=>{t?(console.log(t),e.sendMessage(a,"Failed to send email")):(console.log("Email sent: "+o.response),e.sendMessage(a,"Email sent successfully"))})),i.set(a,t)}}(e,t)}catch(e){console.error(`Error ${o.CALLBACK_QUERY}:`,e)}}))}const{TELEGRAM_BOT_TOKEN:d}=process.env,f={polling:!0};!async function(){if(!d)throw"ERROR: env variables not set.";try{const t=new e(d,f);await m(t),await async function(e=process.env.MONGODB_URI){if(!e)throw"ERROR: env variables not set.";if(r)return r;const t=new n(e,{useUnifiedTopology:!0});try{return await t.connect(),console.log("~Connected to MongoDB"),r=t,r}catch(e){console.error("Error connecting to MongoDB:",e),process.exit(1)}}(),console.log("Telegram bot started")}catch(e){console.error("Error starting Telegram bot:",e),process.exit(1)}}();
