import"dotenv/config.js";import e from"node-telegram-bot-api";import t from"mongodb";import a from"nodemailer";const o={MESSAGE:"message",CALLBACK_QUERY:"callback_query"},s={book_activity_registration:"book_activity_registration",request_legalization:"request_legalization",ask_base_information:"ask_base_information"},{MongoClient:n}=t;let r;const i=new Map,c={};let l={from:process.env.EMAIL_ADDRESS,to:process.env.EMAIL_ADDRESS,subject:"Hello from Telegram Bot",text:"Hello world?"};const _=a.createTransport({service:"gmail",auth:{user:process.env.EMAIL_ADDRESS,pass:process.env.GMAIL_PASSWORD}});function g({bot:e,chatId:t,message:a,firstName:o,reply_to_message:s}){if(function(e){const t=Date.now(),a=(c[e]||[]).filter((e=>t-e<6e4));return a.length>=10||(c[e]=[...a,t],!1)}(t))return void e.sendMessage(t,"You are sending too many requests. Please try again later.");console.log("messageIdsMap",a);let n=i.get(t)===s?.message_id;switch(!0){case/^\/start/i.test(a):!function({bot:e,chatId:t,firstName:a}){e.sendMessage(t,"Привіт 🙋‍♀️Тебе вітає Legal Expert-бот. \nТут ти знайдеш інформацію щодо юридичних послуг для тебе і твого бізнесу\nОбирай ту юридичну послугу, яка тобі пасує\n  ",{reply_markup:{inline_keyboard:[[{text:"Записатися на консультацію",url:process.env.CALENDLY_SCHEDULING_URL}],[{text:"Запис на реєстрацію діяльності",callback_data:"book_activity_registration"}],[{text:"Легалізація",callback_data:"request_legalization"}]]}})}({bot:e,chatId:t,firstName:o});break;case n:!function(e,t){e.sendMessage(t,"Дякуємо ми зв'яжемося з вами щодо вашого питання найближчим часом.")}(e,t);break;default:!function(e,t){e.sendMessage(t,"Sorry, I don't understand.")}(e,t)}}async function m(e){e.on(o.MESSAGE,(t=>{const{chat:{id:a},text:o,from:{first_name:s},reply_to_message:n}=t;try{g({bot:e,chatId:a,message:o,firstName:s,reply_to_message:n})}catch(e){console.error("Error sending message:",e)}})),e.on(o.CALLBACK_QUERY,(t=>{try{!async function(e,{data:t,message:{chat:{id:a}}}){if(t===s.book_activity_registration&&e.sendMessage(a,"Виберіть:",{reply_markup:{one_time_keyboard:!0,inline_keyboard:[[{text:"Реєстрація Spolka z O.O.",url:process.env.GOOGLE_FORM_URL},{text:"Реєстрація JDG",url:process.env.GOOGLE__SUB_FORM_URL}]]}}),t===s.request_legalization&&e.sendMessage(a,"Виберіть:",{reply_markup:{one_time_keyboard:!0,inline_keyboard:[[{text:"Карта побиту з PESEL UKR",callback_data:s.ask_base_information},{text:"Карта побиту",callback_data:s.ask_base_information}],[{text:"Карта резидента",callback_data:s.ask_base_information},{text:"Карта поляка",callback_data:s.ask_base_information}]]}}),t===s.ask_base_information){const{message_id:t,...o}=await e.sendMessage(a,"Підкажіть, будь ласка, ваше ім'я та контактний номер телефону?",{reply_markup:{force_reply:!0}});_.sendMail(l,((t,o)=>{t?(console.log(t),e.sendMessage(a,"Failed to send email")):(console.log("Email sent: "+o.response),e.sendMessage(a,"Email sent successfully"))})),i.set(a,t)}}(e,t)}catch(e){console.error(`Error ${o.CALLBACK_QUERY}:`,e)}}))}const{TELEGRAM_BOT_TOKEN:d}=process.env,f={polling:!0};!async function(){if(!d)throw"ERROR: env variables not set.";try{const t=new e(d,f);await m(t),await async function(e=process.env.MONGODB_URI){if(!e)throw"ERROR: env variables not set.";if(r)return r;const t=new n(e,{useUnifiedTopology:!0});try{return await t.connect(),console.log("~Connected to MongoDB"),r=t,r}catch(e){console.error("Error connecting to MongoDB:",e),process.exit(1)}}(),console.log("Telegram bot started")}catch(e){console.error("Error starting Telegram bot:",e),process.exit(1)}}();
